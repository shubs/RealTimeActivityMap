<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>A simple map</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js'></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>


	<link href='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' />

	<link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="./css/styles.css">
	<link rel="stylesheet" href="./css/flag-icon.min.css">

</head>
<body>
	<div class="wrapper">
	  <header>
	  	<img id="logo" src="https://www.mailjet.com/wp-content/themes/mailjet/mailjet/img/mailjet-logo-white.png">
	  	<h1>Real time signup tracking</h1>
	  	<div class="description">This dashboard locates in real time all the signups.</div>
	  </header>
	</div>

	<div id="map">To get this app to work you need to share your geolocation.</div>

	<div id="infos">
		<ul id='log'></ul>
	</div>

	<script>
		var socket = io();

		L.mapbox.accessToken = 'pk.eyJ1Ijoic2h1YnMiLCJhIjoiY2lmOG50cGx4MDA1OHRma21xdzY5MW41YSJ9.z0yXWQGdadDB0XIxJBrtjQ';
		var map = L.mapbox.map('map', 'mapbox.pencil');

		map.setView(new L.LatLng(30, 0), 3);

		socket.on('new', function(data){
		    var flag = '<span class="flag-icon flag-icon-' + data.iso.toLowerCase() + '"></span>';

		    $('#log').append(
		    	$('<li>').html("[" + data.time + "] " 
		    		+ flag + data.country 
		    		+ " (" + data.ip + ") - <b class='"+data.type+"'>" 
		    		+ data.event+"</b>").delay(15000).hide('slow')
		    );

			// custom marker's icon styles
			var tinyIcon = L.Icon.extend({
				options: {
					shadowUrl: '../assets/marker-shadow.png',
					iconSize: [25, 39],
					iconAnchor:   [12, 36],
					shadowSize: [41, 41],
					shadowAnchor: [12, 38],
					popupAnchor: [0, -30],
				}
			});
			var redIcon = new tinyIcon({ iconUrl: '../assets/marker-red.png' });
			var yellowIcon = new tinyIcon({ iconUrl: '../assets/marker-yellow.png' });

			

			if (data.event == "signin-loaded")
				var myMarker = L.marker([data.latitude, data.longitude], {icon:redIcon });
			else
				var myMarker = L.marker([data.latitude, data.longitude], {icon:yellowIcon });

			myMarker.addTo(map).bindPopup(data.event).openPopup();

			// dispaear after 60 sec
			setTimeout(function(){
				myMarker.setOpacity(0);
			}, 60000);

			//L.marker([data.latitude, data.longitude]).addTo(map).bindPopup("New Signup.").openPopup();
		});
	
	

		var popup = L.popup();

		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
		}

		map.on('click', onMapClick);

	</script>
</body>
</html>